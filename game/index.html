<!DOCTYPE html>

<!-- Zusaetzliche Features: Begrenzte Muniton/VerfÃ¼gbarkeit der Waffen, Deterministischer Modus umschaltbar, ... -->

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kampf-Arena</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ğŸ’ Strategie-Kampf</h1>

<form id="roundForm">
    <label class="checkbox-label">
        <input type="checkbox" name="cbAbsolutMode">
        <span>Deterministischer Modus (Kein Zufall)</span>
    </label>

    <label for="waffe">Waffe wÃ¤hlen (Achte auf Munition!):</label>
    <select name="waffe" id="waffe" required>
        <option value="Faust" data-id="0">ğŸ‘Š Faust (Unendlich)</option>
        <option value="Dolch" data-id="1">ğŸ—¡ï¸ Dolch (Unendlich)</option>
        <option value="Schwert" data-id="2">âš”ï¸ Schwert (5x)</option>
        <option value="Laserschwert" data-id="3">âœ¨ Laserschwert (2x)</option>
        <option value="Magie" data-id="4">ğŸ”¥ Magie (1x - ULT!)</option>
    </select>

    <div style="display:flex; gap:10px;">
        <div style="flex:1">
            <label for="block">Verteidigung:</label>
            <select name="block" id="block" required>
                <option value="Oben">â¬†ï¸ Oben</option>
                <option value="Mitte">â¡ï¸ Mitte</option>
                <option value="Unten">â¬‡ï¸ Unten</option>
            </select>
        </div>
        <div style="flex:1">
            <label for="angriff">Angriff:</label>
            <select name="angriff" id="angriff" required>
                <option value="Oben">â¬†ï¸ Oben</option>
                <option value="Mitte">â¡ï¸ Mitte</option>
                <option value="Unten">â¬‡ï¸ Unten</option>
            </select>
        </div>
    </div>

    <button type="submit">Runde starten âš”ï¸</button>
</form>

<div class="status-box">
    <div style="flex: 1;">
        <strong>ğŸ¦¸ Held</strong>
        <div class="health-bar-container">
            <div id="bar-player" class="health-bar-fill hp-green" style="width: 100%;">Wait...</div>
        </div>
        <span id="text-player">Bereit...</span>
    </div>
    <div style="flex: 1; text-align: right;">
        <strong id="name-enemy">ğŸ‘¾ Gegner</strong>
        <div class="health-bar-container">
            <div id="bar-enemy" class="health-bar-fill hp-red" style="width: 100%;">Wait...</div>
        </div>
        <span id="text-enemy">Bereit...</span>
    </div>
</div>

<div id="output"><i>DrÃ¼cke Start um die Arena zu betreten...</i></div>

<script>
const weaponNames = {
    0: "ğŸ‘Š Faust", 1: "ğŸ—¡ï¸ Dolch", 2: "âš”ï¸ Schwert", 3: "âœ¨ Laser", 4: "ğŸ”¥ Magie"
};

document.getElementById("roundForm").addEventListener("submit", async function(e){
    e.preventDefault();
    const outputDiv = document.getElementById("output");
    const barPlayer = document.getElementById("bar-player");
    const barEnemy = document.getElementById("bar-enemy");
    const textPlayer = document.getElementById("text-player");
    const textEnemy = document.getElementById("text-enemy");
    const nameEnemy = document.getElementById("name-enemy");
    
    try {
        let response = await fetch("logic/Runden.php", { method: "POST", body: new FormData(this) });
        let text = await response.text(); 
        let data = JSON.parse(text);
            
        if (data.error) {
            outputDiv.innerHTML = `<span class="error">âš ï¸ ${data.error}</span>`;
        } else {
            outputDiv.innerHTML = data.text;
            
            if (data.inventory) updateWeaponSelect(data.inventory);
            if (data.finished) setTimeout(() => location.reload(), 3000);

            // HP Balken Update
            if (data.status) {
                let pPct = (data.status.p_hp / data.status.p_max) * 100;
                barPlayer.style.width = Math.max(0, pPct) + "%";
                barPlayer.innerText = data.status.p_hp + " HP";
                textPlayer.innerText = `${data.status.p_hp} / ${data.status.p_max} HP`;

                let ePct = (data.status.e_hp / data.status.e_max) * 100;
                barEnemy.style.width = Math.max(0, ePct) + "%";
                barEnemy.innerText = data.status.e_hp + " HP";
                textEnemy.innerText = `${data.status.e_hp} / ${data.status.e_max} HP`;
                
                nameEnemy.innerText = "ğŸ‘¾ " + data.status.e_name;
            }
        }
    } catch(e) {
        outputDiv.innerHTML = `<span class="error">Netzwerkfehler: ${e}</span>`;
    }
});

function updateWeaponSelect(inventory) {
    const select = document.getElementById('waffe');
    const options = select.options;
    for (let i = 0; i < options.length; i++) {
        const opt = options[i];
        const id = opt.getAttribute('data-id');
        if (inventory[id] !== undefined) {
            let count = inventory[id];
            if (count > 1000) {
                opt.text = `${weaponNames[id]} (âˆ)`;
                opt.disabled = false;
            } else {
                opt.text = `${weaponNames[id]} (${count}x)`;
                if (count <= 0) {
                    opt.disabled = true;
                    opt.text += " - LEER";
                    if (select.value === opt.value) select.value = "Faust";
                } else {
                    opt.disabled = false;
                }
            }
        }
    }
}
</script>

</body>
</html>
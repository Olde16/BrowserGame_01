<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Projekt</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .btn-reset { background-color: #dc3545; margin-top: 10px; }
        .btn-reset:hover { background-color: #c82333; }
        .pact-used { opacity: 0.5; pointer-events: none; text-decoration: line-through; }
    </style>
</head>
<body>

<h1>ğŸ’ Mein RPG Projekt</h1>

<form id="roundForm">

    <label for="waffe">Waffe wÃ¤hlen (Munition!):</label>
    <select name="waffe" id="waffe" required>
        <option value="Faust" data-id="0">ğŸ‘Š Faust (Unendlich)</option>
        <option value="Dolch" data-id="1">ğŸ—¡ï¸ Dolch (Unendlich)</option>
        <option value="Schwert" data-id="2">âš”ï¸ Schwert (5x)</option>
        <option value="Laserschwert" data-id="3">âœ¨ Laserschwert (2x)</option>
        <option value="Magie" data-id="4">ğŸ”¥ Magie (Ulti!)</option>
    </select>

    <div style="display:flex; gap:10px;">
        <div style="flex:1">
            <label for="block">Verteidigung:</label>
            <select name="block" id="block" required>
                <option value="Oben">â¬†ï¸ Oben</option>
                <option value="Mitte">â¡ï¸ Mitte</option>
                <option value="Unten">â¬‡ï¸ Unten</option>
            </select>
        </div>
        <div style="flex:1">
            <label for="angriff">Angriff:</label>
            <select name="angriff" id="angriff" required>
                <option value="Oben">â¬†ï¸ Oben (Headshot Risiko)</option>
                <option value="Mitte">â¡ï¸ Mitte</option>
                <option value="Unten">â¬‡ï¸ Unten</option>
            </select>
        </div>
    </div>

    <div id="pactBox" style="margin-top: 20px; background: #343a40; color:white; padding: 10px; border: 1px solid #000; border-radius: 5px;">
        <label style="color: #dc3545; display:block; margin-bottom:5px;">ğŸ˜ˆ <b>Pakt mit dem Teufel (Einmalig):</b></label>
        <label style="cursor: pointer; display:flex; gap:10px; align-items:center;">
            <input type="checkbox" name="gambleOption" value="1" style="width:20px; height:20px;">
            <span>Pakt schlieÃŸen</span>
        </label>
        <small style="display:block; color: #ccc; margin-top:5px;">
            50% Chance: Heilung & Loot.<br>
            50% Chance: Seelenraub (-100 HP).
        </small>
    </div>

    <button type="submit">Runde starten âš”ï¸</button>
    <button type="button" id="resetBtn" class="btn-reset">ğŸ”„ Spiel Neustarten</button>
</form>

<div class="status-box">
    <div style="flex: 1;">
        <strong>ğŸ¦¸ Held</strong>
        <div class="health-bar-container">
            <div id="bar-player" class="health-bar-fill hp-green" style="width: 100%;">Start</div>
        </div>
        <span id="text-player">250 / 250 HP</span>
    </div>
    <div style="flex: 1; text-align: right;">
        <strong id="name-enemy">ğŸ‘¾ Gegner</strong>
        <div class="health-bar-container">
            <div id="bar-enemy" class="health-bar-fill hp-red" style="width: 100%;">Start</div>
        </div>
        <span id="text-enemy">??? / ??? HP</span>
    </div>
</div>

<div id="output"><i>DrÃ¼cke Start...</i></div>

<script>
const weaponNames = { 0: "ğŸ‘Š Faust", 1: "ğŸ—¡ï¸ Dolch", 2: "âš”ï¸ Schwert", 3: "âœ¨ Laser", 4: "ğŸ”¥ Magie" };

document.getElementById("roundForm").addEventListener("submit", async function(e){
    e.preventDefault();
    await sendData(new FormData(this));
});

document.getElementById("resetBtn").addEventListener("click", async function(){
    if(confirm("Spiel wirklich neu starten?")) {
        let fd = new FormData();
        fd.append("reset", "1");
        await sendData(fd);
    }
});

async function sendData(formData) {
    const outputDiv = document.getElementById("output");
    try {
        let response = await fetch("logic/Runden.php", { method: "POST", body: formData });
        let data = JSON.parse(await response.text());
            
        if (data.error) {
            outputDiv.innerHTML = `<span class="error">âš ï¸ ${data.error}</span>`;
        } else {
            outputDiv.innerHTML = data.text;
            
            if (data.inventory) updateWeaponSelect(data.inventory);
            if (data.finished) setTimeout(() => location.reload(), 3000);

            if (data.status) {
                updateBar("player", data.status.p_hp, data.status.p_max);
                updateBar("enemy", data.status.e_hp, data.status.e_max);
                document.getElementById("name-enemy").innerText = "ğŸ‘¾ " + data.status.e_name;
            }

            // Pakt Box aktualisieren
            let gambleBox = document.querySelector('input[name="gambleOption"]');
            if(gambleBox) gambleBox.checked = false;
            updatePactStatus(data.pact_used);
        }
    } catch(e) { outputDiv.innerHTML = `<span class="error">Fehler: ${e}</span>`; }
}

function updatePactStatus(isUsed) {
    const box = document.getElementById("pactBox");
    const input = document.querySelector('input[name="gambleOption"]');
    
    if (isUsed) {
        box.classList.add("pact-used");
        input.disabled = true;
        box.querySelector("small").innerText = "DER PAKT IST BESIEGELT (Verbraucht).";
    } else {
        box.classList.remove("pact-used");
        input.disabled = false;
        box.querySelector("small").innerHTML = "50% Chance: Heilung & Loot.<br>50% Chance: Seelenraub (-100 HP).";
    }
}

function updateBar(who, val, max) {
    let pct = (val / max) * 100;
    document.getElementById(`bar-${who}`).style.width = Math.max(0, pct) + "%";
    document.getElementById(`bar-${who}`).innerText = val + " HP";
    document.getElementById(`text-${who}`).innerText = `${val} / ${max} HP`;
}

function updateWeaponSelect(inventory) {
    const select = document.getElementById('waffe');
    for (let i = 0; i < select.options.length; i++) {
        const opt = select.options[i];
        const id = opt.getAttribute('data-id');
        if (inventory[id] !== undefined) {
            let count = inventory[id];
            opt.text = (count > 1000) ? `${weaponNames[id]} (âˆ)` : `${weaponNames[id]} (${count}x)`;
            opt.disabled = (count <= 0);
            if (count <= 0 && select.value === opt.value) select.value = "Faust";
        }
    }
}
</script>
</body>
</html>